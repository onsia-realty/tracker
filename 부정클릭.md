# 분양현장 랜딩페이지 + 방문자 추적 시스템

## 프로젝트 배경

### 현재 상황
- ONSIA 청약 상세페이지에 각 분양현장의 "대표 홈페이지" 링크가 있음
- 이 링크들을 **직접 만든 랜딩페이지**로 연결할 예정 (약 50개 현장)
- 스마트로그(smlog.co.kr) 같은 유료 서비스 비용 절감 목적
- **모든 방문자 행동을 100% 추적**하고 싶음

### 목표
1. 분양현장별 랜딩페이지 50개 운영
2. 방문자 추적 (IP 바꿔도, 쿠키 지워도 추적)
3. 부정클릭 탐지 및 차단
4. 광고 효율 분석 (네이버/구글 광고 ROI)
5. 월 비용 0원 (Vercel 무료 플랜 활용)

---

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    ONSIA 청약 상세페이지                      │
│                 (onsia.city/subscriptions/xxx)              │
│                            │                                 │
│                    [대표 홈페이지 링크]                        │
│                            ▼                                 │
├─────────────────────────────────────────────────────────────┤
│              분양현장 랜딩페이지 (50개)                        │
│                                                              │
│   현장1.onsia.city  현장2.onsia.city  현장3.onsia.city ...   │
│   (또는 subdomain 방식: apt1.landing.onsia.city)            │
│                            │                                 │
│                   [추적 스크립트 삽입]                         │
│                            ▼                                 │
├─────────────────────────────────────────────────────────────┤
│                    중앙 추적 서버                             │
│                (tracking.onsia.city/api)                    │
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 세션관리  │  │ 페이지뷰 │  │ 클릭이벤트│  │ 부정클릭  │    │
│  │   API    │  │   API    │  │   API    │  │ 탐지엔진  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
│                            │                                 │
│                            ▼                                 │
│                    PostgreSQL (Neon)                        │
│                     - 무료 512MB                             │
│                     - 3개월 데이터 보관                        │
├─────────────────────────────────────────────────────────────┤
│                    관리자 대시보드                            │
│                (admin.onsia.city/analytics)                 │
│                                                              │
│  - 실시간 방문자 현황                                         │
│  - 현장별 방문 통계                                           │
│  - 유입 경로 분석 (네이버/구글/직접)                            │
│  - 부정클릭 로그 및 차단 IP 목록                               │
│  - 광고 캠페인별 전환율                                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 핵심 기술: 브라우저 핑거프린팅

### 왜 핑거프린팅인가?

**문제점:**
- IP만 추적? → VPN, 모바일 데이터 변경으로 우회
- 쿠키만 추적? → 시크릿 모드, 쿠키 삭제로 우회
- 로그인 기반? → 익명 방문자 추적 불가

**해결책: 브라우저 핑거프린트**
- 브라우저의 고유한 특성들을 조합해 "지문" 생성
- IP 바꿔도, 쿠키 지워도 **같은 브라우저면 같은 지문**
- 정확도: 약 90-95% (완벽하진 않지만 충분함)

### 핑거프린트 구성 요소

```javascript
// 수집하는 정보들 (모두 합법적이고 일반적인 정보)
const fingerprint = {
  // 1. 화면 정보
  screenWidth: 1920,
  screenHeight: 1080,
  colorDepth: 24,
  pixelRatio: 1,

  // 2. 브라우저 정보
  userAgent: "Mozilla/5.0...",
  language: "ko-KR",
  languages: ["ko-KR", "ko", "en-US"],
  platform: "Win32",
  hardwareConcurrency: 8,  // CPU 코어 수
  deviceMemory: 8,         // RAM (GB)

  // 3. 시간대
  timezone: "Asia/Seoul",
  timezoneOffset: -540,

  // 4. Canvas 핑거프린트 (가장 강력)
  // - 똑같은 도형을 그려도 GPU/드라이버에 따라 미세하게 다름
  canvasHash: "a8f9c2d1e4...",

  // 5. WebGL 핑거프린트
  webglVendor: "Google Inc. (NVIDIA)",
  webglRenderer: "ANGLE (NVIDIA GeForce GTX 1660...)",

  // 6. 오디오 핑거프린트
  audioHash: "b7e2f3a9...",

  // 7. 설치된 폰트 (간접 감지)
  fontsHash: "c4d5e6f7...",

  // 8. 기타
  doNotTrack: "1",
  cookieEnabled: true,
  touchSupport: false,
}

// 이 모든 값을 해시 → 고유 ID 생성
// SHA-256("1920|1080|24|1|Mozilla/5.0...|ko-KR|...")
// → "fp_a8c9d2e4f6g8h0i2j4k6l8m0n2o4p6"
```

### 핑거프린트 정확도

| 상황 | 추적 가능 여부 |
|------|---------------|
| 같은 브라우저, IP 변경 | ✅ 추적됨 |
| 같은 브라우저, 쿠키 삭제 | ✅ 추적됨 |
| 같은 브라우저, 시크릿 모드 | ✅ 추적됨 |
| 다른 브라우저 (Chrome→Firefox) | ❌ 새 방문자로 인식 |
| 브라우저 업데이트 후 | ⚠️ 50% 확률로 새 방문자 |
| 다른 기기 (PC→모바일) | ❌ 새 방문자로 인식 |

**결론:** 완벽하진 않지만, 부정클릭 탐지에는 충분함

---

## 부정클릭 탐지 알고리즘

### 1단계: 빈도 기반 탐지

```javascript
// 같은 핑거프린트에서 과도한 클릭
const RULES = {
  // 5분 내 동일 광고 3회 클릭 → 의심
  sameFingerprintSameAd: { window: 5 * 60, threshold: 3, action: 'warn' },

  // 1시간 내 동일 핑거프린트 5회 이상 광고 클릭 → 차단
  sameFingerprintAnyAd: { window: 60 * 60, threshold: 5, action: 'block' },

  // 같은 IP에서 10분 내 5회 클릭 → 의심
  sameIPMultipleClicks: { window: 10 * 60, threshold: 5, action: 'warn' },
}
```

### 2단계: 행동 패턴 탐지

```javascript
// 정상 사용자 vs 부정 클릭 패턴 비교
const BEHAVIOR_RULES = {
  // 페이지 체류시간 3초 미만 + 광고 클릭 → 의심
  lowDwellTimeWithClick: {
    dwellTime: 3,  // 초
    action: 'warn'
  },

  // 스크롤 없이 광고만 클릭 → 의심
  noScrollWithClick: {
    scrollDepth: 10,  // %
    action: 'warn'
  },

  // 마우스 움직임 없이 클릭 → 봇 의심
  noMouseMovement: {
    action: 'block'
  },

  // 같은 좌표 반복 클릭 → 봇 의심
  sameCoordinateClicks: {
    threshold: 3,
    tolerance: 5,  // px
    action: 'block'
  }
}
```

### 3단계: 지역/시간 기반 탐지

```javascript
const GEO_RULES = {
  // 해외 IP에서 한국어 광고 클릭 → 의심
  foreignIPKoreanAd: {
    allowedCountries: ['KR'],
    action: 'warn'
  },

  // 새벽 시간대 대량 클릭 → 의심 (봇 가능성)
  nightTimeHighVolume: {
    hours: [2, 3, 4, 5],  // 새벽 2-6시
    threshold: 10,        // 시간당 10회 이상
    action: 'warn'
  },

  // VPN/프록시 감지
  vpnProxy: {
    detectMethods: ['ipapi', 'ipinfo'],
    action: 'warn'
  }
}
```

### 4단계: 리스크 스코어링

```javascript
// 각 규칙 위반 시 점수 부여
const RISK_SCORES = {
  sameFingerprintSameAd: 30,
  sameFingerprintAnyAd: 50,
  lowDwellTimeWithClick: 20,
  noScrollWithClick: 15,
  noMouseMovement: 80,
  sameCoordinateClicks: 90,
  foreignIPKoreanAd: 25,
  nightTimeHighVolume: 20,
  vpnProxy: 30,
}

// 총점 계산
// 50점 이상 → 의심 (모니터링)
// 80점 이상 → 차단 (광고 숨김)
// 100점 이상 → 블랙리스트 (영구 차단)
```

---

## 대응 액션

### 의심 단계 (50-79점)
- 로그 기록 (상세 행동 데이터 저장)
- 관리자 알림 (슬랙/이메일)
- 광고는 계속 노출 (거짓 양성 방지)

### 차단 단계 (80-99점)
- 광고 노출 차단 (빈 div로 대체)
- 클릭 이벤트 무효화
- 세션 종료 시까지 유지

### 블랙리스트 (100점 이상)
- 핑거프린트 영구 저장
- 해당 사용자 모든 광고 영구 차단
- 네이버/구글 광고 무효 클릭 신고용 데이터 수집

---

## 데이터베이스 설계

### 테이블 구조

```sql
-- 1. 방문자 세션
CREATE TABLE visitor_sessions (
  id TEXT PRIMARY KEY,
  fingerprint TEXT NOT NULL,
  ip_address TEXT,
  user_agent TEXT,
  device_type TEXT,        -- desktop, mobile, tablet
  browser TEXT,
  os TEXT,
  country TEXT,
  city TEXT,
  referrer TEXT,           -- 유입 경로
  utm_source TEXT,         -- naver, google
  utm_medium TEXT,         -- cpc, organic, direct
  utm_campaign TEXT,
  utm_content TEXT,        -- 광고 키워드
  landing_site TEXT,       -- 어떤 분양현장 사이트인지
  first_visit TIMESTAMP DEFAULT NOW(),
  last_visit TIMESTAMP DEFAULT NOW(),
  visit_count INT DEFAULT 1,
  risk_score INT DEFAULT 0,
  is_blocked BOOLEAN DEFAULT FALSE,
  block_reason TEXT
);

-- 2. 페이지 조회
CREATE TABLE page_views (
  id TEXT PRIMARY KEY,
  session_id TEXT REFERENCES visitor_sessions(id),
  landing_site TEXT,       -- 분양현장 식별자
  path TEXT,
  title TEXT,
  enter_time TIMESTAMP DEFAULT NOW(),
  exit_time TIMESTAMP,
  dwell_time INT,          -- 초
  scroll_depth INT,        -- %
  mouse_movements INT,     -- 마우스 이동 횟수
  clicks INT               -- 클릭 횟수
);

-- 3. 클릭 이벤트
CREATE TABLE click_events (
  id TEXT PRIMARY KEY,
  session_id TEXT REFERENCES visitor_sessions(id),
  landing_site TEXT,
  event_type TEXT,         -- ad_click, cta_click, phone_click
  target_element TEXT,
  click_x INT,
  click_y INT,
  ad_source TEXT,          -- naver, google
  ad_campaign TEXT,
  ad_keyword TEXT,
  timestamp TIMESTAMP DEFAULT NOW(),
  is_fraud BOOLEAN DEFAULT FALSE,
  fraud_reason TEXT,
  risk_score INT DEFAULT 0
);

-- 4. 블랙리스트
CREATE TABLE blacklist (
  id TEXT PRIMARY KEY,
  fingerprint TEXT UNIQUE NOT NULL,
  reason TEXT,
  evidence TEXT,           -- JSON: 부정클릭 증거 데이터
  created_at TIMESTAMP DEFAULT NOW()
);

-- 5. 분양현장 정보
CREATE TABLE landing_sites (
  id TEXT PRIMARY KEY,
  name TEXT,               -- "힐스테이트 XX"
  slug TEXT UNIQUE,        -- "hillstate-xx"
  subdomain TEXT,          -- "hillstate-xx.onsia.city"
  cheongyak_id TEXT,       -- 청약홈 HOUSE_MANAGE_NO
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 인덱스 (빠른 조회용)

```sql
CREATE INDEX idx_sessions_fingerprint ON visitor_sessions(fingerprint);
CREATE INDEX idx_sessions_landing_site ON visitor_sessions(landing_site);
CREATE INDEX idx_sessions_first_visit ON visitor_sessions(first_visit);
CREATE INDEX idx_pageviews_session ON page_views(session_id);
CREATE INDEX idx_pageviews_landing_site ON page_views(landing_site);
CREATE INDEX idx_clicks_session ON click_events(session_id);
CREATE INDEX idx_clicks_timestamp ON click_events(timestamp);
CREATE INDEX idx_clicks_is_fraud ON click_events(is_fraud);
CREATE INDEX idx_blacklist_fingerprint ON blacklist(fingerprint);
```

---

## 폴더 구조

```
분양현장_랜딩/
├── apps/
│   ├── tracker/              # 추적 서버 (중앙)
│   │   ├── src/
│   │   │   ├── app/
│   │   │   │   ├── api/
│   │   │   │   │   ├── session/route.ts
│   │   │   │   │   ├── pageview/route.ts
│   │   │   │   │   ├── click/route.ts
│   │   │   │   │   └── stats/route.ts
│   │   │   │   └── admin/
│   │   │   │       ├── page.tsx          # 대시보드
│   │   │   │       ├── visitors/page.tsx
│   │   │   │       ├── fraud/page.tsx
│   │   │   │       └── sites/page.tsx
│   │   │   ├── lib/
│   │   │   │   ├── fingerprint.ts
│   │   │   │   ├── fraudDetection.ts
│   │   │   │   ├── geoip.ts
│   │   │   │   └── prisma.ts
│   │   │   └── components/
│   │   ├── prisma/
│   │   │   └── schema.prisma
│   │   └── package.json
│   │
│   └── landing-template/     # 랜딩페이지 템플릿
│       ├── src/
│       │   ├── app/
│       │   │   ├── page.tsx              # 메인 랜딩
│       │   │   ├── layout.tsx            # 추적 스크립트 포함
│       │   │   ├── gallery/page.tsx
│       │   │   ├── floor-plan/page.tsx
│       │   │   └── contact/page.tsx
│       │   ├── components/
│       │   │   ├── Hero.tsx
│       │   │   ├── Features.tsx
│       │   │   ├── Gallery.tsx
│       │   │   └── ContactForm.tsx
│       │   └── lib/
│       │       └── tracker.ts            # 추적 클라이언트
│       └── package.json
│
├── packages/
│   └── tracker-sdk/          # 추적 SDK (npm 패키지화 가능)
│       ├── src/
│       │   ├── index.ts
│       │   ├── fingerprint.ts
│       │   └── events.ts
│       └── package.json
│
├── scripts/
│   ├── create-landing.ts     # 새 랜딩페이지 생성 스크립트
│   └── deploy-all.ts         # 전체 배포 스크립트
│
├── 부정클릭.md               # 이 문서
├── turbo.json                # Turborepo 설정
└── package.json
```

---

## 랜딩페이지 운영 방식

### 옵션 1: 서브도메인 방식 (추천)
```
힐스테이트XX.onsia.city
래미안YY.onsia.city
...
```
- Vercel에서 와일드카드 도메인 설정
- 하나의 앱으로 50개 사이트 운영
- URL 기반으로 현장 데이터 로드

### 옵션 2: 경로 방식
```
landing.onsia.city/힐스테이트XX
landing.onsia.city/래미안YY
...
```
- 더 간단한 설정
- SEO에는 서브도메인보다 불리

### 옵션 3: 개별 도메인
```
힐스테이트XX.co.kr (별도 구매)
래미안YY.com (별도 구매)
```
- 도메인 비용 발생
- 가장 전문적인 느낌

**추천:** 옵션 1 (서브도메인) - 비용 0원 + 관리 편의성

---

## 구현 로드맵

### Phase 1: 기반 구축 (1주)
- [ ] 프로젝트 초기화 (Turborepo + Next.js)
- [ ] 추적 서버 DB 스키마 설계
- [ ] 핑거프린팅 라이브러리 구현
- [ ] 기본 API 엔드포인트 (session, pageview, click)

### Phase 2: 부정클릭 탐지 (1주)
- [ ] 빈도 기반 탐지 로직
- [ ] 행동 패턴 탐지 로직
- [ ] 리스크 스코어링 시스템
- [ ] 블랙리스트 관리

### Phase 3: 랜딩페이지 템플릿 (1주)
- [ ] 반응형 랜딩페이지 디자인
- [ ] 추적 스크립트 통합
- [ ] 갤러리, 평면도, 문의 페이지
- [ ] 서브도메인 라우팅

### Phase 4: 관리자 대시보드 (1주)
- [ ] 실시간 방문자 현황
- [ ] 현장별 통계
- [ ] 유입 경로 분석
- [ ] 부정클릭 로그 조회

### Phase 5: 배포 및 운영 (ongoing)
- [ ] Vercel 배포
- [ ] 첫 번째 분양현장 적용
- [ ] 모니터링 및 개선

---

## 비용 분석

| 항목 | 스마트로그 (월) | 직접 구축 (월) |
|------|----------------|---------------|
| 기본 요금 | 29,000원~ | 0원 |
| 추가 페이지뷰 | 0.5원/건 | 0원 |
| DB | 포함 | 0원 (Neon 무료) |
| 호스팅 | 포함 | 0원 (Vercel 무료) |
| 50개 사이트 | ~100,000원+ | 0원 |

**연간 절감액:** 약 120만원 이상

---

## 법적 고려사항

### GDPR/개인정보보호법 준수
1. **핑거프린팅 고지**: 개인정보처리방침에 명시
2. **익명화**: 핑거프린트는 해시값만 저장 (원본 복원 불가)
3. **데이터 보관 기간**: 90일 후 자동 삭제
4. **옵트아웃**: 추적 거부 옵션 제공 (Do Not Track 존중)

### 권장 문구 (개인정보처리방침)
```
당사는 서비스 품질 개선 및 부정 이용 방지를 위해
브라우저 핑거프린팅 기술을 사용합니다.

수집 정보: 브라우저 종류, 화면 해상도, 시간대 등
보관 기간: 90일
목적: 방문 통계 분석, 부정클릭 방지
```

---

## 다음 단계

이 문서를 검토한 후, 아래 중 선택:

1. **바로 구현 시작** → Phase 1부터 순차 진행
2. **특정 부분 상세화** → 원하는 섹션 깊이 있게
3. **수정/추가 요청** → 요구사항 변경

어떻게 진행할까?
